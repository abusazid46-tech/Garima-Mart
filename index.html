<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Garima Mart üõí - Scrollable Categories</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Add Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Your original design tokens & base styles preserved */
    :root {
      --primary: #1FA463;
      --primary-dark: #17854d;
      --secondary: #FFD54F;
      --secondary-dark: #f0c23a;
      --light: #f8fff9;
      --dark: #333;
      --gray: #777;
      --light-gray: #f5f5f5;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--light);
      color: var(--dark);
      padding-bottom: 80px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      padding: 18px 15px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .header-top h1 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icons {
      display: flex;
      gap: 18px;
      font-size: 20px;
    }

    .icons i {
      cursor: pointer;
      transition: var(--transition);
    }

    .icons i:hover {
      transform: scale(1.1);
    }

    .location {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-container {
      position: relative;
      margin-top: 10px;
    }

    .search-container input {
      width: 100%;
      padding: 14px 20px 14px 50px;
      border-radius: 50px;
      border: none;
      outline: none;
      font-size: 15px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .search-container input:focus {
      box-shadow: 0 0 0 3px rgba(31, 164, 99, 0.2);
    }

    .search-container i {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 18px;
    }

    .promo-banner {
      background: linear-gradient(to right, #FF8A00, #FFC400);
      color: var(--white);
      padding: 12px 15px;
      text-align: center;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .promo-banner i {
      font-size: 18px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .section {
      padding: 20px 15px;
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-title h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    /* --- HORIZONTAL SCROLL CATEGORIES (CHANGE) --- */
    .categories-scroll {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 5px 0 15px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--light-gray);
      -webkit-overflow-scrolling: touch;
      cursor: grab;
    }

    .categories-scroll:active {
      cursor: grabbing;
    }

    .categories-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .categories-scroll::-webkit-scrollbar-track {
      background: var(--light-gray);
      border-radius: 10px;
    }

    .categories-scroll::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    .categories-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* category card inside scroller */
    .category-scroll-item {
      flex: 0 0 auto;
      width: 100px;              /* fixed width for consistent horizontal scroll */
      background: var(--white);
      padding: 15px 5px;
      text-align: center;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .category-scroll-item:hover {
      transform: translateY(-4px);
      border-color: var(--primary);
    }

    .category-scroll-item i {
      font-size: 28px;
      color: var(--primary);
      margin-bottom: 2px;
    }

    .category-scroll-item span {
      display: block;
      font-size: 12px;
      color: var(--gray);
      font-weight: 400;
    }

    /* original grid kept for fallback but not used */
    .categories {
      display: none;  /* hide the old grid */
    }

    /* Products grid unchanged */
    .products {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .product {
      background: var(--white);
      padding: 15px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .product-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #FF5722;
      color: white;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      z-index: 2;
    }

    /* Improved image styles with loading animation and placeholder */
    .product-img {
      width: 100%;
      height: 130px;
      object-fit: contain;
      margin-bottom: 10px;
      border-radius: 8px;
      background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
      background-size: 200% 100%;
      animation: 1.5s shine linear infinite;
      padding: 10px;
      aspect-ratio: 1/1; /* Added to maintain consistent dimensions */
    }

    .product-img.loaded {
      animation: none;
      background: #f9f9f9;
    }

    @keyframes shine {
      to {
        background-position-x: -200%;
      }
    }

    .product h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product p {
      font-size: 13px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .price {
      font-weight: 700;
      color: var(--primary);
      font-size: 18px;
    }

    .old-price {
      text-decoration: line-through;
      color: var(--gray);
      font-size: 13px;
      margin-left: 5px;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-controls button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: var(--light-gray);
      color: var(--dark);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .quantity-controls button:hover {
      background: var(--primary);
      color: white;
    }

    .quantity-controls span {
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .add-btn {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
      width: 100%;
    }

    .add-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .add-btn.added {
      background: var(--secondary);
      color: var(--dark);
    }

    .cart-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      color: var(--dark);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      z-index: 100;
      border-top: 1px solid #eee;
    }

    .cart-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .cart-icon {
      position: relative;
      font-size: 24px;
      color: var(--primary);
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #FF5722;
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .cart-text h4 {
      font-size: 16px;
      font-weight: 600;
    }

    .cart-text p {
      font-size: 12px;
      color: var(--gray);
    }

    .checkout-btn {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkout-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .floating-btn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--secondary);
      color: var(--dark);
      border: none;
      box-shadow: var(--shadow);
      font-size: 24px;
      cursor: pointer;
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .floating-btn:hover {
      transform: scale(1.1);
      background: var(--secondary-dark);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #c62828;
      background: #ffebee;
      border-radius: 8px;
      margin: 10px;
    }

    .success {
      text-align: center;
      padding: 20px;
      color: var(--primary);
      background: #e8f5e9;
      border-radius: 8px;
      margin: 10px;
    }

    /* ========== AUTH STYLES (unchanged but improved toggle) ========== */
    .auth-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .auth-content {
      background: var(--white);
      margin: 10% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .close-auth {
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      cursor: pointer;
      color: var(--gray);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-form input {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0;
      border: 2px solid var(--light-gray);
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
    }

    .auth-form input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .auth-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 15px 0;
      transition: var(--transition);
    }

    .auth-btn:hover {
      background: var(--primary-dark);
    }

    .auth-btn.logout {
      background: #dc3545;
    }

    .auth-btn.logout:hover {
      background: #c82333;
    }

    .auth-toggle {
      text-align: center;
      margin-top: 15px;
      color: var(--gray);
    }

    .auth-toggle a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-message {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-size: 14px;
    }

    .auth-message.success {
      background: #e8f5e9;
      color: var(--primary);
    }

    .auth-message.error {
      background: #ffebee;
      color: #c62828;
    }

    /* ========== SEARCH RESULTS STYLES ========== */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .search-result-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .search-result-item:hover {
      background: var(--light-gray);
    }

    .search-result-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 6px;
    }

    .search-result-item .info {
      flex: 1;
    }

    .search-result-item h4 {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .search-result-item .price {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }

    .search-result-empty {
      padding: 30px 20px;
      text-align: center;
      color: var(--gray);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 10000;
      animation: slideIn 0.3s ease;
      display: none;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .loading-auth {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }

    @media (min-width: 768px) {
      .products {
        grid-template-columns: repeat(3, 1fr);
      }
      .section {
        padding: 25px 20px;
      }
    }

    @media (min-width: 1024px) {
      .products {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>

<body>

<header>
  <div class="header-top">
    <h1><i class="fas fa-shopping-cart"></i> Garima Mart</h1>
    <div class="icons">
      <i class="fas fa-user-circle" id="authToggle" title="Account"></i>
      <i class="fas fa-heart" title="Wishlist"></i>
      <i class="fas fa-bell" title="Notifications"></i>
    </div>
  </div>
  
  <div class="location">
    <i class="fas fa-map-marker-alt"></i>
    <div>
      Delivering to: <strong>Guwahati, Assam</strong> <br>
      <strong>‡¶Ü‡¶™‡ßã‡¶®‡¶æ‡ß∞ ‡¶¶‡ßÅ‡ß±‡¶æ‡ß∞‡¶¶‡¶≤‡¶ø‡¶≤‡ßà ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡ß∞‡ßÄ</strong>
    </div>
  </div>

  <div class="search-container">
    <i class="fas fa-search"></i>
    <input type="text" id="searchInput" placeholder="Search rice, oil, vegetables | ‡¶ö‡¶æ‡¶â‡¶≤, ‡¶§‡ßá‡¶≤, ‡¶∂‡¶æ‡¶ï-‡¶™‡¶æ‡¶ö‡¶≤‡¶ø">
    <div class="search-results" id="searchResults"></div>
  </div>
</header>

<!-- Authentication Modal -->
<div class="auth-modal" id="authModal">
  <div class="auth-content">
    <span class="close-auth" id="closeAuth">&times;</span>
    <h2>Welcome to Garima Mart</h2>
    
    <!-- Sign Up Form -->
    <div id="signupForm" class="auth-form active">
      <h3>Create Account</h3>
      <div class="auth-message" id="signupMessage"></div>
      <input type="text" id="signupName" placeholder="Full Name" required>
      <input type="email" id="signupEmail" placeholder="Email" required>
      <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required>
      <button id="signupBtn" class="auth-btn">Sign Up</button>
      <p class="auth-toggle">Already have an account? <a href="#" id="showLogin">Login</a></p>
    </div>
    
    <!-- Login Form -->
    <div id="loginForm" class="auth-form">
      <h3>Login</h3>
      <div class="auth-message" id="loginMessage"></div>
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button id="loginBtn" class="auth-btn">Login</button>
      <p class="auth-toggle">New customer? <a href="#" id="showSignup">Create Account</a></p>
    </div>
    
    <!-- Loading -->
    <div id="authLoading" class="loading-auth" style="display: none;">
      <div class="spinner"></div>
      <p id="loadingText">Processing...</p>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Promo Banner -->
<div class="promo-banner">
  <i class="fas fa-gift"></i>
  <span>Today's Special: Get 10% off on all fruits! Use code: FRUIT10</span>
</div>

<!-- Categories - Horizontal Scroll (View all link removed as requested) -->
<div class="section">
  <div class="section-title">
    <h3>Categories | ‡¶∂‡ßç‡ß∞‡ßá‡¶£‡ßÄ</h3>
    <!-- "View all" link completely removed -->
  </div>
  <!-- New scrollable container -->
  <div id="categories-container" class="categories-scroll">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading categories...</p>
    </div>
  </div>
</div>

<!-- Products -->
<div class="section">
  <div class="section-title">
    <h3>Daily Essentials | ‡¶¶‡ßà‡¶®‡¶®‡ßç‡¶¶‡¶ø‡¶® ‡¶™‡ßç‡ß∞‡ßü‡ßã‡¶ú‡¶®</h3>
    <a href="#">See more <i class="fas fa-arrow-right"></i></a>
  </div>
  <div id="products-container" class="products">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading products...</p>
    </div>
  </div>
</div>

<!-- Floating Action Button -->
<button class="floating-btn" title="Quick Actions">
  <i class="fas fa-bolt"></i>
</button>

<!-- Cart Bar -->
<div class="cart-bar">
  <div class="cart-info">
    <div class="cart-icon">
      <i class="fas fa-shopping-bag"></i>
      <div class="cart-count">0</div>
    </div>
    <div class="cart-text">
      <h4>0 items | ‚Çπ0</h4>
      <p>‡¶Æ‡ßÅ‡¶† ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø | Add more to save on delivery</p>
    </div>
  </div>
  <button class="checkout-btn">
    <i class="fas fa-shopping-cart"></i> Checkout
  </button>
</div>

<script>
  /* ========== SUPABASE CONFIG ========== */
  const SUPABASE_CONFIG = {
    url: 'https://kpbjwbdnizifcdipxlpp.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwYmp3YmRuaXppZmNkaXB4bHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzAyMTgsImV4cCI6MjA4NjEwNjIxOH0.eZ9e2CqRw_idlCwzAfw_PN2WnIG6VAz71YAxlRr4WYU'
  };

  let supabaseClient = null;
  let currentUser = null;
  let cartCount = 0;
  let cartTotal = 0;
  let allProducts = [];
  let searchTimeout = null;

  const CACHE_KEYS = {
    CATEGORIES: 'garima_mart_categories',
    PRODUCTS: 'garima_mart_products',
    USER: 'garima_mart_user'
  };

  function saveToLocalCache(key, data) {
    try { localStorage.setItem(key, JSON.stringify(data)); localStorage.setItem(`${key}_timestamp`, Date.now()); } catch (e) { console.warn(e); }
  }
  function getFromLocalCache(key) {
    try { const data = localStorage.getItem(key); const timestamp = localStorage.getItem(`${key}_timestamp`); if (data && timestamp && Date.now() - parseInt(timestamp) < 3600000) return JSON.parse(data); } catch (e) { console.warn(e); } return null;
  }

  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast'); toast.textContent = message; toast.style.display = 'block'; toast.style.background = type === 'success' ? 'var(--primary)' : type === 'error' ? '#dc3545' : 'var(--primary)';
    setTimeout(() => toast.style.display = 'none', 3000);
  }
  function showLoadingAuth(text) {
    document.getElementById('authLoading').style.display = 'block'; document.getElementById('signupForm').style.display = 'none'; document.getElementById('loginForm').style.display = 'none'; document.getElementById('loadingText').textContent = text;
  }
  function hideLoadingAuth() {
    document.getElementById('authLoading').style.display = 'none';
  }
  function showAuthMessage(message, type, formId) {
    const el = document.getElementById(`${formId}Message`); el.textContent = message; el.className = `auth-message ${type}`; el.style.display = 'block';
  }
  function clearAuthMessages() {
    ['signupMessage', 'loginMessage'].forEach(id => { const el = document.getElementById(id); if (el) { el.textContent = ''; el.style.display = 'none'; } });
  }

  /* ========== AUTH ========== (fixed toggles) */
  function initializeSupabase() {
    if (window.supabase && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
      supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey, { auth: { persistSession: true, autoRefreshToken: true } });
      supabaseClient.auth.getSession().then(({ data: { session } }) => { if (session) { currentUser = session.user; updateAuthUI(true); } });
      supabaseClient.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) { currentUser = session.user; updateAuthUI(true); showToast('Login successful!', 'success'); closeAuthModal(); }
        else if (event === 'SIGNED_OUT') { currentUser = null; updateAuthUI(false); }
      });
      return true;
    }
    return false;
  }

  function updateAuthUI(isLoggedIn) {
    const authIcon = document.getElementById('authToggle');
    if (isLoggedIn && currentUser) { authIcon.title = `Logged in as ${currentUser.email}`; authIcon.style.color = 'var(--secondary)'; }
    else { authIcon.title = 'Account'; authIcon.style.color = 'var(--white)'; }
  }

  async function handleSignup() {
    const name = document.getElementById('signupName').value.trim(); const email = document.getElementById('signupEmail').value.trim(); const password = document.getElementById('signupPassword').value.trim();
    if (!name || !email || !password) return showAuthMessage('Please fill all fields', 'error', 'signup');
    if (password.length < 6) return showAuthMessage('Password must be at least 6 characters', 'error', 'signup');
    showLoadingAuth('Creating account...');
    try {
      const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { full_name: name } } });
      if (error) throw error;
      if (data.user) {
        showAuthMessage('Account created! You can login now.', 'success', 'signup');
        document.getElementById('signupName').value = ''; document.getElementById('signupEmail').value = ''; document.getElementById('signupPassword').value = '';
        setTimeout(() => { switchToLogin(); showAuthMessage('Please login with your new account', 'success', 'login'); document.getElementById('loginEmail').value = email; }, 2000);
      }
    } catch (error) { showAuthMessage(error.message, 'error', 'signup'); } finally { hideLoadingAuth(); }
  }

  async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim(); const password = document.getElementById('loginPassword').value.trim();
    if (!email || !password) return showAuthMessage('Please fill all fields', 'error', 'login');
    showLoadingAuth('Logging in...');
    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) throw error;
      if (data.user) { currentUser = data.user; closeAuthModal(); showToast(`Welcome back, ${currentUser.email.split('@')[0]}!`, 'success'); }
    } catch (error) { showAuthMessage('Invalid email or password', 'error', 'login'); } finally { hideLoadingAuth(); }
  }

  async function handleLogout() {
    try { const { error } = await supabaseClient.auth.signOut(); if (error) throw error; currentUser = null; showToast('Logged out successfully', 'success'); } catch (error) { console.error(error); }
  }

  function switchToLogin() { document.getElementById('signupForm').classList.remove('active'); document.getElementById('loginForm').classList.add('active'); clearAuthMessages(); }
  function switchToSignup() { document.getElementById('loginForm').classList.remove('active'); document.getElementById('signupForm').classList.add('active'); clearAuthMessages(); }
  function openAuthModal() { 
    if (currentUser) { showToast('You are already logged in', 'info'); return; } 
    document.getElementById('authModal').style.display = 'block'; clearAuthMessages(); 
  }
  function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; clearAuthMessages(); document.getElementById('signupForm').classList.add('active'); document.getElementById('loginForm').classList.remove('active'); document.getElementById('signupName').value = ''; document.getElementById('signupEmail').value = ''; document.getElementById('signupPassword').value = ''; document.getElementById('loginEmail').value = ''; document.getElementById('loginPassword').value = ''; }

  /* search and rest unchanged */
  function initializeSearch() {
    const searchInput = document.getElementById('searchInput'); const searchResults = document.getElementById('searchResults');
    searchInput.addEventListener('input', function() { const query = this.value.trim().toLowerCase(); if (searchTimeout) clearTimeout(searchTimeout); if (!query) { searchResults.style.display = 'none'; return; } searchTimeout = setTimeout(() => performSearch(query), 300); });
    document.addEventListener('click', function(event) { if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) searchResults.style.display = 'none'; });
  }

  function performSearch(query) { /* same as original - keep */ 
    const searchResults = document.getElementById('searchResults');
    if (!allProducts || allProducts.length === 0) { searchResults.innerHTML = '<div class="search-result-empty">No products available</div>'; searchResults.style.display = 'block'; return; }
    const results = allProducts.filter(p => (p.name_en && p.name_en.toLowerCase().includes(query)) || (p.name_as && p.name_as.toLowerCase().includes(query)));
    if (results.length > 0) {
      let html = ''; results.slice(0, 10).forEach(p => { html += `<div class="search-result-item" data-product-id="${p.id}"><img src="${p.image_url || 'https://images.unsplash.com/photo-1518977676601-b53f82aba655?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}" alt="${p.name_en}"><div class="info"><h4>${p.name_en} (${p.unit})</h4><div class="price">‚Çπ${p.current_price || 0}</div></div></div>`; });
      searchResults.innerHTML = html; 
      document.querySelectorAll('.search-result-item').forEach(item => { item.addEventListener('click', function() { const pid = this.getAttribute('data-product-id'); const prod = allProducts.find(p => p.id == pid); if (prod) { document.getElementById('searchInput').value = prod.name_en; searchResults.style.display = 'none'; showToast(prod.name_en, 'success'); } }); });
    } else { searchResults.innerHTML = `<div class="search-result-empty">No products found for "${query}"</div>`; }
    searchResults.style.display = 'block';
  }

  const categoryIcons = { 'vegetables': 'fas fa-carrot', 'fruits': 'fas fa-apple-alt', 'rice-dal': 'fas fa-utensils', 'dairy': 'fas fa-cheese', 'snacks': 'fas fa-cookie', 'household': 'fas fa-home', 'beverages': 'fas fa-wine-bottle', 'meat': 'fas fa-drumstick-bite', 'bakery': 'fas fa-bread-slice', 'spices': 'fas fa-mortar-pestle', 'default': 'fas fa-shopping-basket' };

  // Function to handle image load completion
  function handleImageLoad(img) {
    img.classList.add('loaded');
  }

  // Function to create optimized image URL with dimensions
  function getOptimizedImageUrl(url, width = 400) {
    if (!url) return url;
    
    // For Unsplash images - optimize size and quality
    if (url.includes('unsplash.com')) {
      // Replace with smaller, optimized version
      return url.replace(/w=\d+/, `w=${width}`).replace(/q=\d+/, 'q=80');
    }
    
    return url;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const isSupabaseReady = initializeSupabase();
    const cartCountElement = document.querySelector('.cart-count'); const cartTotalElement = document.querySelector('.cart-text h4'); const checkoutBtn = document.querySelector('.checkout-btn');
    initializeSearch();

    if (isSupabaseReady) { loadCategories(); loadProducts(); } 
    else { showError('categories-container', 'DB connection failed. Using cache.'); showError('products-container', 'DB connection failed. Using cache.'); loadCachedData(); }

    function showError(containerId, message) { const c = document.getElementById(containerId); if (c) c.innerHTML = `<div class="error">${message}</div>`; }
    function showLoading(containerId) { const c = document.getElementById(containerId); if (c) c.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading...</p></div>`; }

    function loadCachedData() {
      const cachedCategories = getFromLocalCache(CACHE_KEYS.CATEGORIES); if (cachedCategories) displayCategories(cachedCategories);
      const cachedProducts = getFromLocalCache(CACHE_KEYS.PRODUCTS); if (cachedProducts) { allProducts = cachedProducts; displayProducts(cachedProducts); }
    }

    async function loadCategories() {
      showLoading('categories-container');
      try {
        const { data: categories, error } = await supabaseClient.from('categories').select('*').order('id', { ascending: true }).limit(10); // allow more for scroll
        if (error) throw error;
        if (categories && categories.length > 0) { displayCategories(categories); saveToLocalCache(CACHE_KEYS.CATEGORIES, categories); } 
        else showError('categories-container', 'No categories.');
      } catch (error) { console.error(error); showError('categories-container', 'Error. Using cached.'); const cached = getFromLocalCache(CACHE_KEYS.CATEGORIES); if (cached) displayCategories(cached); }
    }

    function displayCategories(categories) {
      const container = document.getElementById('categories-container'); if (!container) return;
      container.innerHTML = ''; // clear loading
      categories.forEach(cat => {
        const card = document.createElement('div'); card.className = 'category-scroll-item'; card.setAttribute('data-category-id', cat.id);
        const icon = categoryIcons[cat.icon_key] || categoryIcons.default;
        card.innerHTML = `<i class="${icon}"></i> ${cat.name_en || 'Cat'} <span>${cat.name_as || ''}</span>`;
        card.addEventListener('click', function() { filterProductsByCategory(cat.id); });
        container.appendChild(card);
      });
      // optional: make drag-scroll friendly
    }

    async function loadProducts(categoryId = null) {
      showLoading('products-container');
      try {
        let query = supabaseClient.from('products').select('*').order('id', { ascending: false }).limit(8);
        if (categoryId) query = query.eq('category_id', categoryId);
        const { data: products, error } = await query;
        if (error) throw error;
        if (products && products.length > 0) { displayProducts(products); if (!categoryId) { allProducts = products; saveToLocalCache(CACHE_KEYS.PRODUCTS, products); } } 
        else showError('products-container', 'No products.');
      } catch (error) { console.error(error); showError('products-container', 'Error. Using cached.'); const cached = getFromLocalCache(CACHE_KEYS.PRODUCTS); if (cached) { allProducts = cached; displayProducts(cached); } }
    }

    function displayProducts(products) {
      const container = document.getElementById('products-container'); container.innerHTML = '';
      products.forEach(p => { container.appendChild(createProductElement(p)); });
      attachProductEventListeners();
    }

    function createProductElement(product) {
      const el = document.createElement('div'); el.className = 'product'; el.setAttribute('data-product-id', product.id);
      let badge = ''; if (product.is_fresh) badge = '<div class="product-badge">FRESH</div>'; else if (product.is_popular) badge = '<div class="product-badge">POPULAR</div>'; else if (product.discount_percentage > 0) badge = `<div class="product-badge">${product.discount_percentage}% OFF</div>`;
      
      // Get optimized image URL with dimensions
      const img = getOptimizedImageUrl(product.image_url) || 'https://images.unsplash.com/photo-1518977676601-b53f82aba655?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
      
      let priceHtml = `<span class="price">‚Çπ${product.current_price || 0}</span>`;
      if (product.original_price && product.original_price > product.current_price) priceHtml += `<span class="old-price">‚Çπ${product.original_price}</span>`;
      
      // Create image with loading="lazy", dimensions, and load handler
      el.innerHTML = `${badge}<img class="product-img" src="${img}" alt="${product.name_en || 'Product'}" width="300" height="300" loading="lazy" onload="this.classList.add('loaded')" onerror="this.src='https://images.unsplash.com/photo-1518977676601-b53f82aba655?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'; this.classList.add('loaded')"><h4>${product.name_en || 'Product'} (${product.unit || '1kg'})</h4><p>${product.name_as || ''} ${product.description ? ' - '+product.description : ''}</p><div class="price-row"><div>${priceHtml}</div><div class="quantity-controls"><button class="qty-minus">-</button><span class="qty">0</span><button class="qty-plus">+</button></div></div><button class="add-btn"><i class="fas fa-cart-plus"></i> ADD</button>`;
      
      return el;
    }

    function filterProductsByCategory(categoryId) {
      document.querySelectorAll('.category-scroll-item').forEach(c => { c.style.borderColor = c.getAttribute('data-category-id') == categoryId ? 'var(--primary)' : 'transparent'; });
      loadProducts(categoryId);
    }

    function attachProductEventListeners() {
      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const product = this.closest('.product'); const price = parseInt(product.querySelector('.price').textContent.replace('‚Çπ',''))||0; const qtyEl = product.querySelector('.qty'); let qty = parseInt(qtyEl.textContent);
          if (qty === 0) { qty = 1; qtyEl.textContent = qty; this.innerHTML = '<i class="fas fa-check"></i> ADDED'; this.classList.add('added'); setTimeout(() => { if (parseInt(qtyEl.textContent) === 0) this.innerHTML = '<i class="fas fa-cart-plus"></i> ADD'; else this.innerHTML = '<i class="fas fa-cart-plus"></i> ADD MORE'; }, 2000); } else { qty += 1; qtyEl.textContent = qty; }
          updateCart(1, price);
        });
      });
      document.querySelectorAll('.qty-plus').forEach(btn => {
        btn.addEventListener('click', function() { const qtyEl = this.previousElementSibling; let qty = parseInt(qtyEl.textContent); qty += 1; qtyEl.textContent = qty; const price = parseInt(this.closest('.product').querySelector('.price').textContent.replace('‚Çπ',''))||0; updateCart(1, price); const addBtn = this.closest('.product').querySelector('.add-btn'); addBtn.innerHTML = '<i class="fas fa-check"></i> ADDED'; addBtn.classList.add('added'); });
      });
      document.querySelectorAll('.qty-minus').forEach(btn => {
        btn.addEventListener('click', function() { const qtyEl = this.nextElementSibling; let qty = parseInt(qtyEl.textContent); if (qty > 0) { qty -= 1; qtyEl.textContent = qty; const price = parseInt(this.closest('.product').querySelector('.price').textContent.replace('‚Çπ',''))||0; updateCart(-1, price); if (qty === 0) { const addBtn = this.closest('.product').querySelector('.add-btn'); addBtn.innerHTML = '<i class="fas fa-cart-plus"></i> ADD'; addBtn.classList.remove('added'); } } });
      });
    }

    function updateCart(change, price) {
      cartCount += change; cartTotal += change * price;
      cartCountElement.textContent = cartCount; cartTotalElement.textContent = `${cartCount} items | ‚Çπ${cartTotal}`;
      checkoutBtn.innerHTML = cartCount > 0 ? `<i class="fas fa-shopping-cart"></i> Checkout (‚Çπ${cartTotal})` : `<i class="fas fa-shopping-cart"></i> Checkout`;
    }

    checkoutBtn.addEventListener('click', function() {
      if (cartCount === 0) showToast('Cart empty!', 'error');
      else if (!currentUser) { showToast('Login to checkout', 'error'); openAuthModal(); }
      else { showToast(`Order placed! Total: ‚Çπ${cartTotal}`, 'success'); cartCount = 0; cartTotal = 0; cartCountElement.textContent = '0'; cartTotalElement.textContent = '0 items | ‚Çπ0'; checkoutBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Checkout'; document.querySelectorAll('.qty').forEach(q => q.textContent='0'); document.querySelectorAll('.add-btn').forEach(b => { b.innerHTML='<i class="fas fa-cart-plus"></i> ADD'; b.classList.remove('added'); }); }
    });

    document.getElementById('authToggle').addEventListener('click', openAuthModal);
    document.getElementById('closeAuth').addEventListener('click', closeAuthModal);
    document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); switchToLogin(); });
    document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); switchToSignup(); });
    document.getElementById('signupBtn').addEventListener('click', handleSignup);
    document.getElementById('loginBtn').addEventListener('click', handleLogin);

    window.addEventListener('click', (e) => { if (e.target === document.getElementById('authModal')) closeAuthModal(); });

    document.querySelector('.fa-bell').addEventListener('click', () => showToast('üì¢ 2 notifications', 'info'));
    document.querySelector('.fa-heart').addEventListener('click', () => { if (!currentUser) { showToast('Login to use wishlist', 'error'); openAuthModal(); } else showToast('‚ù§Ô∏è Wishlist empty', 'info'); });
    document.querySelector('.floating-btn').addEventListener('click', () => showToast('‚ö° Quick actions', 'info'));

    // Remove 'See more' link functionality? keep as info toast
    document.querySelectorAll('.section-title a').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showToast('Coming soon!', 'info'); }); });
    document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { performSearch(e.target.value.toLowerCase()); e.target.blur(); } });
  });
</script>

</body>
</html>
